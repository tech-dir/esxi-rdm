# Проброс диска в VM для ESXi

## Проблема

Иногда бывает необходимость напрямую пробросить в ESXi HDD или SSD диск в виртуальную машину, чтоб она с ним работала на прямую.

Для PCI устройств, флешек - это делается очень просто. Но вот *pass-through* для дисков может быть не тривиальной задачей, с множеством манипуляций и команд.

## Решение

RDM (Raw Device Mapping) для физических дисков в VMware ESXi позволяет решить задачу проброса дисков в виртуальную машину. Для этого необходимо использовать встроенную утилиту vmkfstools.

В общем случае необходимо выполнить команду:
```
vmkfstools -z /vmfs/devices/disks/DEVICE_NAME VMDK_PATH
```

Для этого необходимо указать полное имя диска - DEVICE_NAME и полный путь к файлу создаваемого диска VMDK_PATH.
Скрипт позволяет упростить данную процедуру.
#### Шаг 1: Включите SSH на ESXi
1. Войдите в веб-интерфейс ESXi.
2. Перейдите на вкладку **"Host"** (Хост).
3. Откройте **"Actions"** (Действия) > **"Services"** (Сервисы) > **"Enable Secure Shell (SSH)"** (Включить SSH).
#### Шаг 2: Склонируйте репозиторий
Склонируйте git репозиторий на локальную машину

```
git clone https://github.com/tech-dir/esxi-rdm.git
cd esxi-rdm
chmod +x run.sh
```
#### Шаг 3: Заполните данные для подключения по SSH (credentials)
В папке **config** есть конфигурационный файл, который можно заполнить. Если значения каких-то из полей не заполнено - скрипт запросит недостающие.  

```
ESXI_IP=
ESXI_USER=root
ESXI_PASSWORD=
```
#### Шаг 4: Запустите скрипт

```
./run.sh
```

#### Описание работы скриптов
Скрипт run.sh делает следующее:
1. проверяет на локальной машине наличие пакета sshpass (если надо - установит)
2. проверяет credentials для установки ssh соединения
3. попробует установить ssh соединение с указанными данными
4. создаст папку на удаленной машине, куда будет скопирован скрипт (create.sh)
5. копирует скрипт *create.sh* на удаленную машину
6. добавляет права на исполнение
6. запускает скрипт *create.sh* в интерактивном режиме на удаленной машине esxi

Скрипт create.sh делает следующее:
1. выводит список доступных Datastore
2. предлагает выбрать в каком Datastore будет создана папка, в которой будут хранится .vmdk файлы с проброшенными дисками
3. созадет в выбранном Datastore папку
4. выводит список подключенных дисков
5. предлагает указать (через пробел) диски, для которых необходимо сделать .vmdk файлы
6. выполняет команду vmkfstools -z с указаными параметрами и сохраняет .vmdk файлы в выбранный Datastore и созданную папку